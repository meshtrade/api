#!/usr/bin/env bash
set -Eeuo pipefail
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
trap 'handle_error $LINENO' ERR

handle_error() {
  local exit_code=$?
  local line_number=$1
  echo
  echo "âŒ ERROR in $(basename "$0") on line $line_number: GENERATE ALL FAILED!!"
  exit "$exit_code"
}
trap 'handle_error $LINENO' ERR

echo "ðŸ§¹ Cleaning Go generated files..."
find ./go \
  \( -name '*.pb.go' -o -name '*.pb.gw.go' -o -name '*.meshgo.go' -o -name '*.validate.go' \) \
  -print0 | xargs -0 -r -P 4 -n 1 rm
echo

echo "ðŸ§¹ Cleaning Python generated files..."
find ./python/src/meshtrade -type f \( -name '*_meshpy.py' -o -name '*_pb2_grpc.py' -o -name '*_pb2.py' -o -name '*_pb2.pyi' \) -print0 | xargs -0 -r -P 4 rm
echo

echo "ðŸ§¹ Cleaning Js + Ts generated files..."
rm -rf ./ts/dist
find ./ts/src \
  \( -name '*pb.d.ts' -o -name '*pb.js' -o -name '*Pb.ts' -o -name '*_meshts.js' -o -name '*_meshts.d.ts' \) \
  -print0 | xargs -0 -r -P 4 -n 1 rm
echo

echo "ðŸ§¹ Cleaning Java generated files..."
# Clean standard protobuf/gRPC generated files
find ./java/src/main/java -type f \( -name '*Grpc.java' -o -name '*OuterClass.java' \) -print0 | xargs -0 -r rm
# Clean protobuf-generated directories (build/, meshtrade/)
rm -rf ./java/src/main/java/build ./java/src/main/java/meshtrade
# Clean meshjava generated files by looking for generation comment
grep -r -l "Generated by protoc-gen-meshjava" ./java/src/main/java/co/meshtrade/api --include="*.java" | xargs -r rm 2>/dev/null || true
echo

echo "ðŸ§¹ Cleaning Documentation generated files..."
find ./docs/docs/api-reference \
  \( -name '*_meshdoc.mdx' -o -name '*_meshdoc.ts' \) \
  -print0 | xargs -0 -r -P 4 rm

# Clean new generated index.mdx files
find ./docs/docs/api-reference -path "*/service/*/index.mdx" -print0 | xargs -0 -r -P 4 rm
find ./docs/docs/api-reference -path "*/service/index.mdx" -print0 | xargs -0 -r -P 4 rm
find ./docs/docs/api-reference -path "*/type/index.mdx" -print0 | xargs -0 -r -P 4 rm
find ./docs/docs/api-reference -path "*/type/*/index.mdx" -print0 | xargs -0 -r -P 4 rm
echo  

echo "ðŸ§¹ Cleaning Python duplicate nested structure..."
rm -rf ./python/src/meshtrade/meshtrade
echo

echo "ðŸ›  Building protoc-gen-meshts plugin..."
cd tool/protoc-gen-meshts/cmd
yarn build
cd ../../..
echo

echo "ðŸ›  Building protoc-gen-meshjava plugin..."
cd tool/protoc-gen-meshjava
mvn clean package -q
cd ../..
echo

echo "ðŸš€ Generating new files from protobuf definitions..."
buf generate  --template "$SCRIPT_DIR/buf/buf.gen.yaml"
echo

echo "ðŸš€ Generating buf/validate TypeScript files..."
buf generate buf.build/bufbuild/protovalidate --template "$SCRIPT_DIR/buf/buf.gen.validate.yaml"
echo

echo "ðŸ“„ Generating TypeScript index.ts files..."
cd tool/protoc-gen-meshts/scripts
node generate-index-files.js
cd ../../..
echo

echo "ðŸš€ Formatting Python code with ruff..."
ruff check . --fix --quiet || true
echo

echo "############################################################"
echo "#                                                          #"
echo "#  ðŸŽ‰ Done! All code generation is complete!  -\(^-^)/-    #"
echo "#                                                          #"
echo "############################################################"