syntax = "proto3";

package meshtrade.wallet.account.v1;

import "buf/validate/validate.proto";
import "meshtrade/iam/role/v1/role.proto";
import "meshtrade/option/v1/method_type.proto";
import "meshtrade/wallet/account/v1/account.proto";

option go_package = "github.com/meshtrade/api/go/wallet/account/v1;account_v1";
option java_package = "co.meshtrade.api.wallet.account.v1";

service AccountService {
  // create account, not yet open, call open account to open
  rpc CreateAccount(CreateAccountRequest) returns (meshtrade.wallet.account.v1.Account) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_WRITE;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_ACCOUNT_ADMIN
      ]
    };
  }

  // update account only display name can be changed
  rpc UpdateAccount(UpdateAccountRequest) returns (meshtrade.wallet.account.v1.Account) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_WRITE;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_ACCOUNT_ADMIN
      ]
    };
  }

  rpc OpenAccount(OpenAccountRequest) returns (OpenAccountResponse) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_WRITE;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_ACCOUNT_ADMIN
      ]
    };
  }

  rpc CloseAccount(CloseAccountRequest) returns (CloseAccountResponse) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_WRITE;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_ACCOUNT_ADMIN
      ]
    };
  }

  rpc GetAccount(GetAccountRequest) returns (meshtrade.wallet.account.v1.Account) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_READ;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_VIEWER,
        ROLE_WALLET_ACCOUNT_ADMIN,
        ROLE_WALLET_ACCOUNT_VIEWER
      ]
    };
  }

  rpc GetAccountByNumber(GetAccountByNumberRequest) returns (meshtrade.wallet.account.v1.Account) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_READ;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_VIEWER,
        ROLE_WALLET_ACCOUNT_ADMIN,
        ROLE_WALLET_ACCOUNT_VIEWER
      ]
    };
  }

  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_READ;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_VIEWER,
        ROLE_WALLET_ACCOUNT_ADMIN,
        ROLE_WALLET_ACCOUNT_VIEWER
      ]
    };
  }


  rpc SearchAccounts(SearchAccountsRequest) returns (SearchAccountsResponse) {
    option (meshtrade.option.v1.method_type) = METHOD_TYPE_READ;
    option (meshtrade.iam.role.v1.roles) = {
      roles: [
        ROLE_WALLET_ADMIN,
        ROLE_WALLET_VIEWER,
        ROLE_WALLET_ACCOUNT_ADMIN,
        ROLE_WALLET_ACCOUNT_VIEWER        
      ]
    };
  }
}

message CreateAccountRequest {
  meshtrade.wallet.account.v1.Account account = 1  [(buf.validate.field) = {required: true}];
}

message UpdateAccountRequest {
  meshtrade.wallet.account.v1.Account account = 1  [(buf.validate.field) = {required: true}];
}

message OpenAccountRequest {
  /*
    acocunt to open
  */
  string name = 1 [(buf.validate.field) = {
    string: {
      len: 33,
      pattern: "^accounts/[0-9A-Z]{26}$"
    }
  }];
}

message OpenAccountResponse {
  // opened account
  meshtrade.wallet.account.v1.Account account = 1;

  // transaction resource name : transactions/{ULIDv2} to monitor opening
  string ledger_transaction = 3;
}

message CloseAccountRequest {
  /*
    acocunt to close
  */
  string name = 1 [(buf.validate.field) = {
    string: {
      len: 33,
      pattern: "^accounts/[0-9A-Z]{26}$"
    }
  }];
}

message CloseAccountResponse {
  // opened account
  meshtrade.wallet.account.v1.Account account = 1;

  // transaction resource name : transactions/{ULIDv2} to monitor opening
  string ledger_transaction = 3;
}

message GetAccountRequest {
  string name = 1 [(buf.validate.field) = {
    string: {
      len: 33,
      pattern: "^accounts/[0-9A-Z]{26}$"
    }
  }];
  
  // Populate live ledger data with retrieval
  bool populate_ledger_data = 2;
}

message GetAccountByNumberRequest {
  /*
     The Unique Mesh Account Number
     Must be a 7-digit number starting with '1'.
  */
  string account_number = 1 [(buf.validate.field) = {
    string: {
      pattern: "^1[0-9]{6}$"
    }
  }];

  // Populate live ledger data with retrieval
  bool populate_ledger_data = 2;
}

/*
 Request to list all accounts in executing group hierarchy.
*/
message ListAccountsRequest {
  /*
     Sorting configuration for organizing results.
  */
  message Sorting {
    /*
       Field to sort by (e.g., "number").
    */
    string field = 1 [(buf.validate.field) = {
      string: {
        in: [
          "",
          "number"
        ]
      }
      cel: {
        id: "field.valid"
        message: "field must be one of: number, or empty"
        expression: "this in ['', 'number']"
      }
    }];  
  }

  // Populate live ledger data with retrieval
  bool populate_ledger_data = 2;
}

message ListAccountsResponse {
  repeated meshtrade.wallet.account.v1.Account accounts = 1;
}

/* SearchAccountsRequest specifies the query for finding accounts. */
message SearchAccountsRequest {
  /*
     Sorting configuration for organizing results.
  */
  message Sorting {
    /*
       Field to sort by (e.g., "number").
    */
    string field = 1 [(buf.validate.field) = {
      string: {
        in: [
          "",
          "number"
        ]
      }
      cel: {
        id: "field.valid"
        message: "field must be one of: number, or empty"
        expression: "this in ['', 'number']"
      }
    }];  
  }

  /*
     A substring to search for within account display names.
  */
  string display_name = 2;

  // Populate live ledger data with retrieval
  bool populate_ledger_data = 3;
}

message SearchAccountsResponse {
  repeated meshtrade.wallet.account.v1.Account accounts = 1;
}
