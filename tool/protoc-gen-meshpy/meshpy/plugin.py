"""
Core protoc plugin implementation for meshpy.
"""

import sys

from google.protobuf.compiler import plugin_pb2 as plugin


class MeshPyPlugin:
    """Minimal protoc plugin that just proves it can be called."""

    def run(self):
        """Main plugin entry point."""
        # Read the CodeGeneratorRequest from stdin
        data = sys.stdin.buffer.read()
        request = plugin.CodeGeneratorRequest()
        request.ParseFromString(data)

        # Create a response
        response = plugin.CodeGeneratorResponse()

        # For now, just add a simple comment to prove we're running
        # We'll find any Python file and add a comment to it
        for proto_file in request.proto_file:
            if len(proto_file.service) > 0:  # Only process files with services
                # Generate a simple test file
                file_to_generate = plugin.CodeGeneratorResponse.File()
                file_to_generate.name = "python/src/test_meshpy_plugin.py"
                file_to_generate.content = f"""# This file was generated by protoc-gen-meshpy
# Processed proto file: {proto_file.name}
# Services found: {[svc.name for svc in proto_file.service]}

print("protoc-gen-meshpy is working!")
"""
                response.file.append(file_to_generate)

        # Write the response to stdout
        sys.stdout.buffer.write(response.SerializeToString())
