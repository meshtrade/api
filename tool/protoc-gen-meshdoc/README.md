# protoc-gen-meshdoc

A Protocol Buffer compiler plugin that generates comprehensive MDX documentation for Mesh API services, with built-in support for [buf/validate](https://buf.build/docs/ecosystem/other-languages/protovalidate-go) field validation rules.

## Overview

This plugin automatically extracts information from protobuf files and generates:
- Service overview documentation
- Method documentation with code examples (Go, Python)
- Type documentation with field descriptions and validation rules
- Navigation sidebar for Docusaurus

## Validation Support

The plugin automatically parses `buf.validate.field` annotations and translates them into human-readable documentation for the **Required** and **Validation** columns.

### Required Column Logic

Fields are marked as **Required = Yes** when:
- `string` fields have `min_len: 1` or higher
- `string` fields have `len: N` (exact length requirement)
- Enum fields have validation constraints
- CEL expressions check for non-empty values (e.g., `size(this) > 0`)

Fields are marked as **Required = No** when:
- No validation constraints are found
- Only `max_len` is specified (without `min_len`)
- Field has `optional` presence in proto3

### Validation Column Translation

The plugin translates buf/validate rules into concise, table-safe descriptions:

| buf/validate Rule | Documentation Output |
|------------------|---------------------|
| `string: {min_len: 1, max_len: 255}` | `Length min: 1, max: 255 characters` |
| `string: {len: 43}` | `Exactly 43 characters` |
| `string: {pattern: "^[A-Z]+$"}` | `Pattern: ^[A-Z]+$` |
| `int32: {gte: 1, lte: 100}` | `Range: ≥ 1, ≤ 100` |
| `int32: {gt: 0, lt: 100}` | `Range: > 0, < 100` |
| `enum: {...}` | `Must be a valid enum value` |
| Multiple constraints | Combined with ` \| ` separator |

### CEL Expression Handling

CEL expressions are handled with special consideration:

- **Custom messages**: When a `message` field is provided, it's used directly
- **Automatic expressions**: Expressions are abbreviated if over 50 characters
- **Required detection**: Expressions like `size(this) > 0` automatically mark fields as required

Example:
```protobuf
string api_key = 1 [(buf.validate.field) = {
  cel: {
    id: "api_key.required"
    message: "API key must be exactly 43 characters"
    expression: "size(this) == 43"
  }
}];
```

Output: **Required:** Yes | **Validation:** API key must be exactly 43 characters

### Table Safety Features

All validation text is automatically sanitized to prevent Markdown table breaking:

- **Newlines** → Replaced with ` | ` separators
- **Pipe characters** → Escaped as `\|`
- **Long text** → Truncated to 200 characters with `...`
- **Tabs** → Converted to spaces
- **Multiple spaces** → Collapsed to single spaces

This ensures generated documentation tables always render correctly in Docusaurus.

## Usage

The plugin is automatically invoked during the code generation process:

```bash
# Generate all documentation
./scripts/code-generation/generate-all.sh

# Or invoke buf directly
buf generate
```

## Generated File Structure

```
docs/docs/api-reference/
├── {domain}/{service}/{version}/
│   ├── index.mdx                    # Service overview (editable)
│   ├── service/
│   │   ├── index.mdx               # Service methods list
│   │   └── {method}/index.mdx      # Individual method docs  
│   └── type/
│       ├── index.mdx               # Type overview
│       └── {type}/index.mdx        # Individual type docs
└── sidebar_meshdoc.ts              # Navigation structure
```

## File Types

### Generated Files (Never Edit)
- All files with `Generated by protoc-gen-meshdoc. DO NOT EDIT.` header
- Files ending with `*_meshdoc.mdx` patterns  
- `sidebar_meshdoc.ts` navigation file
- All method and type documentation files

### Editable Files  
- Service overview files (`index.mdx`) after initial generation
- These can be enhanced with custom documentation

## Configuration

### Dependencies

The plugin requires these Go modules:
```go
require (
    buf.build/gen/go/bufbuild/protovalidate/protocolbuffers/go v1.36.6
    buf.build/go/protovalidate v0.13.1
    google.golang.org/protobuf v1.36.2
)
```

### Template Functions

Available template functions:
- `kebabCase` - Convert to kebab-case URLs
- `titleCase` - Convert to Title Case display
- `snakeCase` - Convert to snake_case  
- `normalizeTable` - Basic table text sanitization
- `sanitizeForTable` - Advanced validation text sanitization
- `escapeCurly` - Escape curly braces for MDX

## Error Handling

The plugin gracefully handles edge cases:

- **Missing validation** → Field shows "None" in validation column
- **Malformed extensions** → Logs warning, continues with empty validation
- **Parse failures** → Falls back to presence-based required detection
- **Long validation text** → Automatically truncated with `...`

## Development

### Building
```bash
go build -o protoc-gen-meshdoc .
```

### Testing
The plugin can be tested against existing protobuf files:
```bash
# Test with a specific proto file
protoc --plugin=./protoc-gen-meshdoc --meshdoc_out=. test.proto
```

### Adding New Validation Types

To support additional buf/validate constraint types:

1. Add new case to the `switch constraint := fieldConstraint.Type.(type)` block
2. Implement the constraint parsing logic
3. Add documentation examples to this README
4. Test with protobuf files using the new constraints

## Examples

### String Validation
```protobuf
message User {
  string email = 1 [(buf.validate.field) = {
    string: {
      min_len: 1
      max_len: 320
      pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    }
  }];
}
```

Generated documentation:
- **Required:** Yes
- **Validation:** Length min: 1, max: 320 characters | Pattern: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$

### Numeric Validation
```protobuf
message Product {
  int32 quantity = 1 [(buf.validate.field) = {
    int32: {
      gte: 1
      lte: 1000
    }
  }];
}
```

Generated documentation:
- **Required:** No
- **Validation:** Range: ≥ 1, ≤ 1000

### Complex CEL Validation
```protobuf
message APICredentials {
  string api_key = 1 [(buf.validate.field) = {
    string: {
      len: 43
      pattern: "^[A-Za-z0-9_-]{43}$"
    }
    cel: {
      id: "api_key.format"
      message: "API key must be base64 URL-safe encoded"
      expression: "this.matches('^[A-Za-z0-9_-]{43}$')"
    }
  }];
}
```

Generated documentation:
- **Required:** Yes  
- **Validation:** Exactly 43 characters | Pattern: ^[A-Za-z0-9_-]{43}$ | API key must be base64 URL-safe encoded

## Troubleshooting

### Table Rendering Issues
If documentation tables appear broken:
1. Check for unescaped pipe characters in validation text
2. Verify no fields have extremely long validation descriptions
3. Look for newlines in field descriptions

### Missing Validation Rules  
If validation rules don't appear:
1. Ensure `buf.validate.field` annotations are present in proto files
2. Check that buf/validate dependencies are properly installed
3. Verify the plugin binary is up to date

### Build Errors
If the plugin fails to build:
1. Check Go module dependencies are available
2. Ensure protobuf files are valid and parseable
3. Verify all imports are accessible

## Contributing

When adding new features:
1. Maintain table safety in all output
2. Add comprehensive documentation examples
3. Test with real protobuf files
4. Ensure backward compatibility with existing generated docs