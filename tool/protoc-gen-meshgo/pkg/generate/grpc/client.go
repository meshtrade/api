package grpc

import (
	"strings"

	"github.com/meshtrade/api/tool/protoc-gen-meshgo/pkg/generate"
	"github.com/meshtrade/api/tool/protoc-gen-meshgo/pkg/generate/serviceProvider"
	"google.golang.org/protobuf/compiler/protogen"
)

func Client(p *protogen.Plugin, f *protogen.File, svc *protogen.Service) error {
	// Generate only the main service file - no more options file needed
	return generateClientFile(p, f, svc)
}


func generateClientFile(p *protogen.Plugin, f *protogen.File, svc *protogen.Service) error {
	// Generate minimal service file using BaseGRPCClient
	g := p.NewGeneratedFile(
		serviceProvider.GenerateFilename(f.Desc.Path(), ""),
		f.GoImportPath,
	)

	// Add header
	g.P("// Code generated by protoc-gen-meshgo. DO NOT EDIT.")
	g.P("// source: ", f.Desc.Path())
	g.P("package ", f.GoPackageName)
	g.P()

	clientInterfaceName := svc.GoName + "ClientInterface"
	clientStructName := strings.ToLower(string(svc.GoName[0])) + svc.GoName[1:]

	// Generate combined interface
	g.P("// ", clientInterfaceName, " is a gRPC service for the ", svc.GoName, " service.")
	g.P("// It combines the service interface with resource management capabilities using")
	g.P("// the common BaseGRPCClient for consistent authentication, timeouts, and tracing.")
	g.P("//")
	g.P("// Example usage:")
	g.P("//")
	g.P("//\tservice, err := New", svc.GoName, "(")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithAPIKey"), "(\"your-api-key\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithGroup"), "(\"groups/your-group-id\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithTimeout"), "(30 * time.Second),")
	g.P("//\t)")
	g.P("//\tif err != nil {")
	g.P("//\t\tlog.Fatal(err)")
	g.P("//\t}")
	g.P("//\tdefer service.Close()")
	g.P("type ", clientInterfaceName, " interface {")
	g.P("\t", svc.GoName)
	g.P("\t", generate.GRPCClientPkg.Ident("GRPCClient"))
	g.P("}")
	g.P()

	// Generate minimal client struct that embeds BaseGRPCClient
	g.P("// ", clientStructName, " is the internal implementation of the ", clientInterfaceName, " interface.")
	g.P("// It embeds BaseGRPCClient to provide all common gRPC functionality.")
	g.P("type ", clientStructName, " struct {")
	g.P("\t*", generate.GRPCClientPkg.Ident("BaseGRPCClient"), "[", svc.GoName, "Client]")
	g.P("}")
	g.P()

	// Add interface implementation check
	g.P("// ensure ", clientStructName, " implements the ", clientInterfaceName, " interface")
	g.P("var _ ", clientInterfaceName, " = &", clientStructName, "{}")
	g.P()

	// Generate ultra-simple constructor
	g.P("// New", svc.GoName, " creates a new gRPC service for the ", svc.GoName, " service.")
	g.P("// The service uses the common BaseGRPCClient for all functionality including")
	g.P("// connection management, authentication, timeouts, and distributed tracing.")
	g.P("//")
	g.P("// Parameters:")
	g.P("//   - opts: Functional options to configure the client")
	g.P("//")
	g.P("// Returns:")
	g.P("//   - ", clientInterfaceName, ": Configured service instance")
	g.P("//   - error: Configuration or connection error")
	g.P("func New", svc.GoName, "(opts ...", generate.GRPCConfigPkg.Ident("ServiceOption"), ") (", clientInterfaceName, ", error) {")
	g.P("\tbase, err := ", generate.GRPCClientPkg.Ident("NewBaseGRPCClient"), "(")
	g.P("\t\t", svc.GoName, "ServiceProviderName,")
	g.P("\t\tNew", svc.GoName, "Client,")
	g.P("\t\topts...,")
	g.P("\t)")
	g.P("\tif err != nil {")
	g.P("\t\treturn nil, err")
	g.P("\t}")
	g.P("\treturn &", clientStructName, "{BaseGRPCClient: base}, nil")
	g.P("}")
	g.P()

	// Generate ultra-clean method implementations with full type safety
	for i, method := range svc.Methods {
		g.P("// ", method.GoName, " executes the ", method.GoName, " RPC method with automatic")
		g.P("// timeout handling, distributed tracing, and authentication.")
		g.P("func (s *", clientStructName, ") ", method.GoName, "(ctx ", generate.ContextPkg.Ident("Context"), ", request *", method.Input.GoIdent, ") (*", method.Output.GoIdent, ", error) {")
		g.P("\treturn ", generate.GRPCClientPkg.Ident("Execute"), "(s.Executor(), ctx, \"", method.GoName, "\", func(ctx ", generate.ContextPkg.Ident("Context"), ") (*", method.Output.GoIdent, ", error) {")
		g.P("\t\treturn s.GrpcClient().", method.GoName, "(ctx, request)")
		g.P("\t})")
		g.P("}")

		if i != len(svc.Methods)-1 {
			g.P()
		}
	}

	return nil
}
