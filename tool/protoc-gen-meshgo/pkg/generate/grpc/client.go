package grpc

import (
	"strings"

	"github.com/meshtrade/api/tool/protoc-gen-meshgo/pkg/generate"
	"github.com/meshtrade/api/tool/protoc-gen-meshgo/pkg/generate/serviceProvider"
	"google.golang.org/protobuf/compiler/protogen"
)

// generateDocURL creates a dynamic documentation URL from the proto file path
// e.g., "meshtrade/iam/api_user/v1/service.proto" -> "iam/api_user/v1"
func generateDocURL(protoPath string) string {
	// Remove "meshtrade/" prefix and "/service.proto" suffix
	path := strings.TrimPrefix(protoPath, "meshtrade/")
	if idx := strings.LastIndex(path, "/"); idx != -1 {
		path = path[:idx] // Remove filename
	}
	return path
}

func Client(p *protogen.Plugin, f *protogen.File, svc *protogen.Service) error {
	// Generate only the main service file - no more options file needed
	return generateClientFile(p, f, svc)
}


func generateClientFile(p *protogen.Plugin, f *protogen.File, svc *protogen.Service) error {
	// Generate minimal service file using BaseGRPCClient
	g := p.NewGeneratedFile(
		serviceProvider.GenerateFilename(f.Desc.Path(), ""),
		f.GoImportPath,
	)

	// Add header
	g.P("// Code generated by protoc-gen-meshgo. DO NOT EDIT.")
	g.P("// source: ", f.Desc.Path())
	g.P("package ", f.GoPackageName)
	g.P()

	clientInterfaceName := svc.GoName + "ClientInterface"
	clientStructName := strings.ToLower(string(svc.GoName[0])) + svc.GoName[1:]

	// Generate documentation URL
	docURL := generateDocURL(f.Desc.Path())
	
	// Generate combined interface with comprehensive documentation
	g.P("// ", clientInterfaceName, " is a gRPC service for the ", svc.GoName, " service.")
	g.P("// It combines the service interface with resource management capabilities using")
	g.P("// the common BaseGRPCClient for consistent authentication, timeouts, and tracing.")
	g.P("//")
	g.P("// Full Service documentation: https://meshtrade.github.io/api/docs/api-reference/", docURL)
	g.P("//")
	g.P("// Basic service usage with default SDK Configuration:")
	g.P("//")
	g.P("//\tservice, err := New", svc.GoName, "()")
	g.P("//\tif err != nil {")
	g.P("//\t\tlog.Fatal(err)")
	g.P("//\t}")
	g.P("//\tdefer service.Close() // ensures proper cleanup of underlying connection")
	g.P("//")
	g.P("// With default configuration API credentials are searched for using the standard discovery hierarchy:")
	g.P("//")
	g.P("// 1. MESH_API_CREDENTIALS environment variable")
	g.P("// 2. Default credential file location:")
	g.P("//")
	g.P("//    - Linux:   $XDG_CONFIG_HOME/mesh/credentials.json or fallback to $HOME/.config/mesh/credentials.json")
	g.P("//    - macOS:   $HOME/Library/Application Support/mesh/credentials.json")  
	g.P("//    - Windows: C:\\Users\\<user>\\AppData\\Roaming\\mesh\\credentials.json")
	g.P("//")
	g.P("// For more information on authentication: https://meshtrade.github.io/api/docs/architecture/authentication")
	g.P("//")
	g.P("// The service may also be configured with custom options:")
	g.P("//")
	g.P("//\tservice, err := New", svc.GoName, "(")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithURL"), "(\"api.staging.example.com:443\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithAPIKey"), "(\"your-api-key\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithGroup"), "(\"groups/your-group-id\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithTimeout"), "(30 * time.Second),")
	g.P("//\t)")
	g.P("//\tif err != nil {")
	g.P("//\t\tlog.Fatal(err)")
	g.P("//\t}")
	g.P("//\tdefer service.Close() // ensures proper cleanup of underlying connection")
	g.P("//")
	g.P("// For more information on service configuration: https://meshtrade.github.io/api/docs/architecture/sdk-configuration")
	g.P("type ", clientInterfaceName, " interface {")
	g.P("\t", svc.GoName)
	g.P("\t", generate.GRPCClientPkg.Ident("GRPCClient"))
	g.P("}")
	g.P()

	// Generate minimal client struct that embeds BaseGRPCClient
	g.P("// ", clientStructName, " is the internal implementation of the ", clientInterfaceName, " interface.")
	g.P("// It embeds BaseGRPCClient to provide all common gRPC functionality.")
	g.P("type ", clientStructName, " struct {")
	g.P("\t*", generate.GRPCClientPkg.Ident("BaseGRPCClient"), "[", svc.GoName, "Client]")
	g.P("}")
	g.P()

	// Add interface implementation check
	g.P("// ensure ", clientStructName, " implements the ", clientInterfaceName, " interface")
	g.P("var _ ", clientInterfaceName, " = &", clientStructName, "{}")
	g.P()

	// Generate comprehensive constructor documentation
	g.P("// New", svc.GoName, " creates and initializes the ", svc.GoName, " service.")
	g.P("// The service uses the common BaseGRPCClient for all functionality including")
	g.P("// connection management, authentication, timeouts, and distributed tracing.")
	g.P("//")
	g.P("// Full Service documentation: https://meshtrade.github.io/api/docs/api-reference/", docURL)
	g.P("//")
	g.P("// With default configuration API credentials are searched for using the standard discovery hierarchy:")
	g.P("//")
	g.P("// 1. MESH_API_CREDENTIALS environment variable")
	g.P("// 2. Default credential file location:")
	g.P("//")
	g.P("//    - Linux:   $XDG_CONFIG_HOME/mesh/credentials.json or fallback to $HOME/.config/mesh/credentials.json")
	g.P("//    - macOS:   $HOME/Library/Application Support/mesh/credentials.json")
	g.P("//    - Windows: C:\\Users\\<user>\\AppData\\Roaming\\mesh\\credentials.json")
	g.P("//")
	g.P("// For more information on authentication: https://meshtrade.github.io/api/docs/architecture/authentication")
	g.P("//")
	g.P("// For more information on service configuration: https://meshtrade.github.io/api/docs/architecture/sdk-configuration")
	g.P("//")
	g.P("// Examples:")
	g.P("//")
	g.P("//\t// Create with default configuration")
	g.P("//\tservice, err := New", svc.GoName, "()")
	g.P("//\tif err != nil {")
	g.P("//\t\tlog.Fatal(err)")
	g.P("//\t}")
	g.P("//\tdefer service.Close()")
	g.P("//")
	g.P("//\t// Create with custom configuration")
	g.P("//\tservice, err := New", svc.GoName, "(")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithURL"), "(\"api.example.com:443\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithAPIKey"), "(\"your-api-key\"),")
	g.P("//\t\t", generate.GRPCConfigPkg.Ident("WithGroup"), "(\"groups/your-group-id\"),")
	g.P("//\t)")
	g.P("//\tif err != nil {")
	g.P("//\t\tlog.Fatal(err)")
	g.P("//\t}")
	g.P("//\tdefer service.Close()")
	g.P("//")
	g.P("// Parameters:")
	g.P("//   - opts: Functional options to configure the client")
	g.P("//")
	g.P("// Returns:")
	g.P("//   - ", clientInterfaceName, ": Configured service instance")
	g.P("//   - error: Configuration or connection error")
	g.P("func New", svc.GoName, "(opts ...", generate.GRPCConfigPkg.Ident("ServiceOption"), ") (", clientInterfaceName, ", error) {")
	g.P("\tbase, err := ", generate.GRPCClientPkg.Ident("NewBaseGRPCClient"), "(")
	g.P("\t\t", svc.GoName, "ServiceProviderName,")
	g.P("\t\tNew", svc.GoName, "Client,")
	g.P("\t\topts...,")
	g.P("\t)")
	g.P("\tif err != nil {")
	g.P("\t\treturn nil, err")
	g.P("\t}")
	g.P("\treturn &", clientStructName, "{BaseGRPCClient: base}, nil")
	g.P("}")
	g.P()

	// Generate ultra-clean method implementations with full type safety
	for i, method := range svc.Methods {
		g.P("// ", method.GoName, " executes the ", method.GoName, " RPC method with automatic")
		g.P("// timeout handling, distributed tracing, and authentication.")
		g.P("func (s *", clientStructName, ") ", method.GoName, "(ctx ", generate.ContextPkg.Ident("Context"), ", request *", method.Input.GoIdent, ") (*", method.Output.GoIdent, ", error) {")
		g.P("\treturn ", generate.GRPCClientPkg.Ident("Execute"), "(s.Executor(), ctx, \"", method.GoName, "\", func(ctx ", generate.ContextPkg.Ident("Context"), ") (*", method.Output.GoIdent, ", error) {")
		g.P("\t\treturn s.GrpcClient().", method.GoName, "(ctx, request)")
		g.P("\t})")
		g.P("}")

		if i != len(svc.Methods)-1 {
			g.P()
		}
	}

	return nil
}
