# Resource Hierarchy

## Purpose
Defines hierarchical resource ownership and multi-tenancy boundaries through groups.

## Core Concept
Groups are the fundamental organizational units that provide hierarchical ownership and multi-tenancy boundaries for all resources. Every resource in the system belongs to exactly one group, while groups themselves can own other groups, forming tree structures that model real-world organizational relationships.

## Key Implementation Points
- **Universal Ownership**: Every resource has exactly one owner group
- **Hierarchical Structure**: Groups form tree relationships through ownership
- **Read Inheritance**: Parent groups can read descendant resources
- **Write Restriction**: Only direct owners can modify resources
- **Multi-tenancy Isolation**: Complete separation between organizational hierarchies

## Essential Example

A trading firm demonstrates universal user integration:

- **Executives**: Regular users with broad read access
- **Traders**: Regular users with trading permissions in specific groups
- **Risk Systems**: API users with read-only monitoring access
- **Order Management**: API users with automated trading capabilities

Both user types follow identical ownership rules and role assignments within the same hierarchical structure.

### Ownership Model

Each resource maintains an `owner` field pointing to its direct parent group, with the system internally tracking complete hierarchical paths for efficient access control:

<div style={{textAlign: 'center'}}>

```mermaid
graph TD
    Root["üè¢ Root Group
    groups/01ABC123...XYZ
    owner: self"]
    CompanyA["üè¢ Company A
    groups/01DEF456...ABC
    owner: Root"]
    TeamX["üë• Team X
    groups/01GHI789...DEF
    owner: Company A"]
    Account["üë§ User Account
    accounts/01JKL012...GHI
    owner: Team X"]

    Root --> CompanyA
    CompanyA --> TeamX
    TeamX --> Account

    style Root fill:#e1f5fe
    style CompanyA fill:#c8e6c9
    style TeamX fill:#fff3e0
    style Account fill:#fce4ec
```

</div>


### Universal Ownership

Every resource in Mesh has an owner group, including users, accounts, orders, and instruments:

<div style={{textAlign: 'center'}}>

```mermaid
graph TD
    Root["üè¢ Root Org
    üè∑Ô∏è Resource Type: Group"]
    CompanyA["üè¢ Company A
    üè∑Ô∏è Resource Type: Group"]
    TeamA["üë• Team Alpha
    üè∑Ô∏è Resource Type: Group"]
    TeamB["üë• Team Beta
    üè∑Ô∏è Resource Type: Group"]

    RegUser1["üë§ Regular User
    üè∑Ô∏è Resource Type: User
    Username/Password"]
    ApiUser1["üîë API User
    üè∑Ô∏è Resource Type: API User
    API Key"]
    Account1["üí∞ Trading Account
    üè∑Ô∏è Resource Type: Account"]
    Order1["üìä Limit Order
    üè∑Ô∏è Resource Type: Order"]

    Root --> CompanyA
    CompanyA --> TeamA
    CompanyA --> TeamB
    TeamA --> RegUser1
    TeamA --> ApiUser1
    TeamA --> Account1
    TeamA --> Order1

    style Root fill:#e1f5fe
    style CompanyA fill:#c8e6c9
    style TeamA fill:#fff3e0
    style RegUser1 fill:#fce4ec
    style ApiUser1 fill:#f3e5f5
    style Account1 fill:#e8f5e8
    style Order1 fill:#fff8e1
```

</div>

### Access Control Patterns

**Read Operations**: Access resources owned by executing group OR any descendant groups.

**Write Operations**: Access only resources directly owned by executing group.

<div style={{textAlign: 'center'}}>

```mermaid
graph TD
    CompanyA["üè¢ Company A
    üîç Executing Group"]
    TeamX["üë• Team X"]
    TeamY["üë• Team Y"]

    Res1["üìä Resource 1
    owner: Company A
    ‚úÖ Read Access"]
    Res2["üìä Resource 2
    owner: Team X
    ‚úÖ Read Access"]
    Res3["üìä Resource 3
    owner: Team Y
    ‚úÖ Read Access"]

    CompanyA --> TeamX
    CompanyA --> TeamY
    CompanyA -.-> Res1
    TeamX -.-> Res2
    TeamY -.-> Res3

    style CompanyA fill:#e1f5fe
    style Res1 fill:#c8e6c9
    style Res2 fill:#c8e6c9
    style Res3 fill:#c8e6c9
```

</div>

<div style={{textAlign: 'center'}}>

```mermaid
graph TD
    CompanyA["üè¢ Company A
    üîç Executing Group"]
    TeamX["üë• Team X"]
    TeamY["üë• Team Y"]

    Res1["üìä Resource 1
    owner: Company A
    ‚úÖ Write Access"]
    Res2["üìä Resource 2
    owner: Team X
    ‚ùå No Write Access"]
    Res3["üìä Resource 3
    owner: Team Y
    ‚ùå No Write Access"]

    CompanyA --> TeamX
    CompanyA --> TeamY
    CompanyA -.-> Res1
    TeamX -.-> Res2
    TeamY -.-> Res3

    style CompanyA fill:#e1f5fe
    style Res1 fill:#c8e6c9
    style Res2 fill:#ffcdd2
    style Res3 fill:#ffcdd2
```

</div>

## Integration

The resource hierarchy system integrates with other architecture components:

- [Legal Entity Boundaries](./legal-entities) - Client structuring within group hierarchy
- [Method Permissions](./method-permissions) - Role system for operation control
- [API Access](./api-access) - Authentication and group context

## API Reference
[Group Service API Reference](/docs/api-reference/iam/group/v1) - Complete API documentation for group management operations

---

## Detailed Examples

### Multi-Tenant Brokerage Platform

This example demonstrates how groups represent **legal entities** at every level of the hierarchy. Each group corresponds to a real-world legal entity (individual, corporation, trust, etc.) that undergoes KYC/compliance verification by its parent group.

**Legal Entity Hierarchy:**
- **Mesh Platform**: The root legal entity providing the platform infrastructure
- **Broker Companies**: Legal entities (corporations) that are KYC'd by Mesh and provide brokerage services
- **Client Entities**: Legal entities (individuals, companies, trusts) that are KYC'd by their respective brokers

```mermaid
graph TD
    subgraph "Brokerage Platform with Legal Entity Structure"
        Mesh["üè¢ Mesh Platform (Legal Entity)
groups/MESH_ROOT
üìã Compliance Entity: Platform Provider"]
        MeshClient["üèõÔ∏è Mesh Client Entity
clients/MESH_CLIENT
üìã Legal Status: Corporation"]

        BrokerA["üè¶ Broker A Corporation
groups/BROKER_A
üìã KYC'd by: Mesh Platform"]
        BrokerAClient["üè¢ Broker A Client Entity
clients/BROKER_A_CLIENT
üìã Legal Status: Financial Services Corp"]

        BrokerB["üè¶ Broker B LLC
groups/BROKER_B
üìã KYC'd by: Mesh Platform"]
        BrokerBClient["üè¢ Broker B Client Entity
clients/BROKER_B_CLIENT
üìã Legal Status: Limited Liability Company"]
        
        ClientA1["üë§ Individual Client A1
groups/CLIENT_A1
üìã KYC'd by: Broker A"]
        ClientA1Entity["üë§ Client A1 Entity
clients/CLIENT_A1_ENTITY
üìã Legal Status: Natural Person"]
        A1RegUser["üë§ John Smith (Regular User)
users/JOHN_SMITH
üìã Auth: Username/Password
üìã Role: Individual Trader"]
        A1ApiUser["üîë John's Trading Bot (API User)
api_users/JOHN_BOT
üìã Auth: API Key
üìã Role: Automated Trading"]
        
        ClientA2["üè¢ Corporate Client A2
groups/CLIENT_A2
üìã KYC'd by: Broker A"]
        ClientA2Entity["üè¢ Client A2 Entity
clients/CLIENT_A2_ENTITY
üìã Legal Status: Investment Company"]
        A2RegUser["üë§ Sarah Johnson (Regular User)
users/SARAH_JOHNSON
üìã Auth: Google OAuth
üìã Role: Portfolio Manager"]
        A2ApiUser["üîë Corp Risk System (API User)
api_users/CORP_RISK
üìã Auth: API Key
üìã Role: Risk Monitoring"]
        
        ClientB1["üèõÔ∏è Trust Client B1
groups/CLIENT_B1
üìã KYC'd by: Broker B"]
        ClientB1Entity["üèõÔ∏è Client B1 Entity
clients/CLIENT_B1_ENTITY
üìã Legal Status: Family Trust"]
        B1RegUser["üë§ Trust Manager (Regular User)
users/TRUST_MGR
üìã Auth: SSO/SAML
üìã Role: Trust Administrator"]
        
        AccA1["üí∞ Individual Trading Account
accounts/ACC_A1_MAIN
owner: CLIENT_A1"]

        AccA2["üí∞ Corporate Trading Account
accounts/ACC_A2_TRADE
owner: CLIENT_A2"]

        AccB1["üí∞ Trust Settlement Account
accounts/ACC_B1_SETTLE
owner: CLIENT_B1"]

        OrderA1["üìä Individual Buy Order
orders/ORDER_BUY_123
owner: CLIENT_A1
üí° Created via: Web Trading Interface"]

        OrderA2["üìä Automated Sell Order
orders/ORDER_SELL_456
owner: CLIENT_A2
üí° Created via: API Integration"]
        
        Mesh --> MeshClient
        Mesh --> BrokerA
        Mesh --> BrokerB
        BrokerA --> BrokerAClient
        BrokerB --> BrokerBClient
        BrokerA --> ClientA1
        BrokerA --> ClientA2
        BrokerB --> ClientB1
        ClientA1 --> ClientA1Entity
        ClientA2 --> ClientA2Entity
        ClientB1 --> ClientB1Entity
        ClientA1 --> A1RegUser
        ClientA1 --> A1ApiUser
        ClientA2 --> A2RegUser
        ClientA2 --> A2ApiUser
        ClientB1 --> B1RegUser
        ClientA1 --> AccA1
        ClientA2 --> AccA2
        ClientB1 --> AccB1
        ClientA1 --> OrderA1
        ClientA2 --> OrderA2
    end
```

**Key Legal Entity Relationships:**

**Compliance Chain:**
- **Mesh Platform** ‚Üê KYC'd by regulators/auditors ‚Üê **Broker A & B** ‚Üê KYC'd by Mesh ‚Üê **Client Entities** ‚Üê KYC'd by their brokers

**Entity Types Supported:**
- **Natural Persons**: Individual traders and investors (`CLIENT_A1`)
- **Corporations**: Investment companies and fund managers (`CLIENT_A2`)
- **Trusts & Foundations**: Estate planning and wealth management entities (`CLIENT_B1`)
- **Financial Institutions**: Broker-dealers and registered investment advisors (`BROKER_A`, `BROKER_B`)

**Access Scenarios:**

**Broker A Admin executing ListAccounts (READ method):**
- ‚úÖ Can see Account A1-Main (descendant: CLIENT_A1)
- ‚úÖ Can see Account A2-Trading (descendant: CLIENT_A2)  
- ‚ùå Cannot see Account B1-Settlement (different broker)

**John Smith (Regular User) executing CreateOrder via Web Interface (WRITE method):**
- ‚úÖ Can create orders owned by CLIENT_A1 (his legal entity group)
- ‚ùå Cannot create orders owned by CLIENT_A2 (different client)
- ‚ùå Cannot create orders owned by BROKER_A (not direct ownership)
- **Access Method**: Logs in via username/password, same authorization rules apply

**John's Trading Bot (API User) executing CreateOrder via API (WRITE method):**
- ‚úÖ Can create orders owned by CLIENT_A1 (same ownership as regular user)
- ‚ùå Cannot create orders owned by CLIENT_A2 (different client)
- ‚ùå Cannot create orders owned by BROKER_A (not direct ownership)
- **Access Method**: Authenticates via API key, identical permissions to regular user

**Sarah Johnson (Regular User) executing GetAccount via Mobile App (READ method):**
- ‚úÖ Can view CLIENT_A2 corporate accounts (her group's resources)
- ‚úÖ Can view parent group accounts (hierarchical READ access)
- ‚ùå Cannot view CLIENT_A1 individual accounts (different client branch)
- **Cross-Platform**: Same permissions whether using web dashboard, mobile app, or desktop client

**Corporate Risk System (API User) executing ListOrders via API (READ method):**
- ‚úÖ Can read all CLIENT_A2 orders for risk analysis
- ‚úÖ Can read parent group data for consolidated reporting
- ‚ùå Cannot read CLIENT_A1 orders (different ownership branch)
- **Automation**: Enables automated risk monitoring with same permission model

### Investment Bank with Fund Structures

This example shows how complex financial institutions organize multiple fund structures, departments, and trading desks within a single institutional hierarchy. Each level represents distinct legal entities with their own compliance requirements and operational structures.

```mermaid
graph TD
    subgraph "Investment Bank Organizational Structure"
        Bank["üèõÔ∏è Goldman Sachs International
groups/GOLDMAN_INTL
üìã Legal Entity: Investment Bank"]
        BankClient["üè¢ Goldman Client Entity
clients/GOLDMAN_CLIENT
üìã Legal Status: Financial Institution"]
        
        subgraph "Fund Structures"
            AlphaFund["üíº Alpha Hedge Fund LP
groups/ALPHA_FUND
üìã Legal Entity: Limited Partnership
üìã KYC'd by: Goldman Sachs"]
            AlphaFundClient["üìä Alpha Fund Client
clients/ALPHA_FUND_CLIENT
üìã Legal Status: Investment Vehicle"]

            BetaFund["üíº Beta Real Estate Fund
groups/BETA_FUND
üìã Legal Entity: REIT Corporation
üìã KYC'd by: Goldman Sachs"]
            BetaFundClient["üè¢ Beta Fund Client
clients/BETA_FUND_CLIENT
üìã Legal Status: REIT Corporation"]
        end
        
        subgraph "Alpha Fund Departments"
            AlphaResearch["üî¨ Alpha Research Division
groups/ALPHA_RESEARCH
üìã Internal Department"]
            AlphaRisk["‚öñÔ∏è Alpha Risk Management
groups/ALPHA_RISK
üìã Internal Department"]
        end
        
        subgraph "Trading Desks"
            BondDesk["üìà Fixed Income Desk
groups/BOND_DESK
üìã Trading Department
üìã Specialization: Government & Corporate Bonds"]
            ForexDesk["üí± Foreign Exchange Desk
groups/FOREX_DESK
üìã Trading Department
üìã Specialization: Currency Trading"]
            MetalsDesk["ü•á Precious Metals Desk
groups/METALS_DESK
üìã Trading Department
üìã Specialization: Gold, Silver, Commodities"]
        end
        
        subgraph "Users & System Access"
            BondTrader["üë§ Bond Trader (Regular User)
users/BOND_TRADER_001
üìã Auth: SSO/Active Directory
üìã Access: Trading Terminal"]
            BondTradingBot["üîë Bond Algo System (API User)
api_users/BOND_ALGO
üìã Auth: API Key
üìã Access: Automated Trading"]

            ForexAnalyst["üë§ FX Analyst (Regular User)
users/FX_ANALYST_001
üìã Auth: Username/Password
üìã Access: Risk Dashboard"]
            ForexPricingAPI["üîë FX Pricing Feed (API User)
api_users/FX_PRICING
üìã Auth: API Key
üìã Access: Market Data"]

            MetalsManager["üë§ Metals Desk Head (Regular User)
users/METALS_HEAD
üìã Auth: Smart Card + PIN
üìã Access: Management Console"]
        end
        
        subgraph "Accounts & Trading Activity"
            AlphaFundAcc["üí∞ Alpha Fund Master Account
accounts/ALPHA_MASTER_ACC
owner: ALPHA_FUND
Balance: $500M"]

            BetaFundAcc["üí∞ Beta Fund Property Account
accounts/BETA_PROPERTY_ACC
owner: BETA_FUND
Balance: $200M"]

            AlphaResearchAcc["üí∞ Research Analysis Account
accounts/ALPHA_RESEARCH_ACC
owner: ALPHA_RESEARCH
Balance: $5M"]

            BondDeskAcc["üí∞ Bond Trading Account
accounts/BOND_TRADING_ACC
owner: BOND_DESK
Balance: $50M"]

            ForexDeskAcc["üí∞ FX Trading Account
accounts/FOREX_TRADING_ACC
owner: FOREX_DESK
Balance: $75M"]

            MetalsDeskAcc["üí∞ Metals Trading Account
accounts/METALS_TRADING_ACC
owner: METALS_DESK
Balance: $25M"]
            
            GoldTrade["üìä Gold Futures Order
orders/GOLD_FUTURES_001
owner: METALS_DESK
Amount: $2M Long Position
üí° Created by: Regular User via Terminal"]

            BondTrade["üìä Treasury Bond Order
orders/TREASURY_BOND_001
owner: BOND_DESK
Amount: $10M 10-Year Notes
üí° Created by: API Integration"]

            FXTrade["üìä EUR/USD Trade
orders/EUR_USD_001
owner: FOREX_DESK
Amount: ‚Ç¨5M Currency Swap
üí° Created by: Regular User via Dashboard"]
        end
        
        Bank --> BankClient
        Bank --> AlphaFund
        Bank --> BetaFund
        Bank --> BondDesk
        Bank --> ForexDesk
        Bank --> MetalsDesk
        
        BondDesk --> BondTrader
        BondDesk --> BondTradingBot
        ForexDesk --> ForexAnalyst
        ForexDesk --> ForexPricingAPI
        MetalsDesk --> MetalsManager
        
        AlphaFund --> AlphaFundClient
        BetaFund --> BetaFundClient
        AlphaFund --> AlphaResearch
        AlphaFund --> AlphaRisk
        
        AlphaFund --> AlphaFundAcc
        BetaFund --> BetaFundAcc
        AlphaResearch --> AlphaResearchAcc
        BondDesk --> BondDeskAcc
        ForexDesk --> ForexDeskAcc
        MetalsDesk --> MetalsDeskAcc
        
        MetalsDesk --> GoldTrade
        BondDesk --> BondTrade
        ForexDesk --> FXTrade
    end
```

**Multi-Level Organizational Structure:**

**Investment Bank Level (`GOLDMAN_INTL`):**
- **Primary Legal Entity**: Licensed investment bank with regulatory oversight
- **Direct Children**: Fund structures and trading desks
- **Access Rights**: Can read all descendant fund and desk activities (hierarchical READ access)
- **Compliance Role**: Consolidated reporting and regulatory compliance for all subsidiaries

**Fund Level (`ALPHA_FUND`, `BETA_FUND`):**
- **Legal Structure**: Separate legal entities (LP, REIT) with independent governance
- **Fund Departments**: Internal divisions for research, risk management, operations
- **Fund Accounts**: Master accounts holding pooled investor capital
- **Access Rights**: Full control over fund-specific resources, limited access to bank-level resources

**Department Level (`ALPHA_RESEARCH`, `BOND_DESK`, etc.):**
- **Operational Units**: Functional departments within larger entities
- **Specialized Accounts**: Department-specific trading and operational accounts  
- **Trading Activity**: Orders and positions managed at department level
- **Access Rights**: Direct ownership of department resources only

**Access Control Scenarios:**

**Goldman Sachs Bank Admin executing ListAccounts (READ method):**
- ‚úÖ Can see all fund accounts (`ALPHA_MASTER_ACC`, `BETA_PROPERTY_ACC`)
- ‚úÖ Can see all desk accounts (`BOND_TRADING_ACC`, `FOREX_TRADING_ACC`, `METALS_TRADING_ACC`)
- ‚úÖ Can see all department accounts (`ALPHA_RESEARCH_ACC`)
- **Use Case**: Consolidated risk monitoring and regulatory reporting across all entities

**Bond Trader (Regular User) executing CreateOrder via Trading Terminal (WRITE method):**
- ‚úÖ Can create orders owned by `BOND_DESK` (his department group)
- ‚ùå Cannot create orders owned by `FOREX_DESK` (different desk)
- ‚ùå Cannot create orders owned by `ALPHA_FUND` (different entity level)
- **Authentication**: SSO/Active Directory with role-based terminal access
- **Interface**: Desktop trading terminal with real-time market data

**Bond Algo System (API User) executing CreateOrder via API (WRITE method):**
- ‚úÖ Can create orders owned by `BOND_DESK` (same permissions as regular trader)
- ‚ùå Cannot create orders owned by `FOREX_DESK` (same restrictions apply)
- ‚ùå Cannot create orders owned by `ALPHA_FUND` (entity separation maintained)
- **Authentication**: API key with identical authorization scope as regular users
- **Integration**: Automated algorithmic trading with same business rules

**FX Analyst (Regular User) executing GetAccount via Risk Dashboard (READ method):**
- ‚úÖ Can view `FOREX_TRADING_ACC` (his desk's account)
- ‚úÖ Can view parent bank accounts (hierarchical READ access)
- ‚ùå Cannot view `BOND_TRADING_ACC` (different desk, sibling level)
- **Access Method**: Web-based risk dashboard with real-time position monitoring
- **Cross-Platform**: Same permissions via mobile app or web interface

**Metals Desk Head (Regular User) executing UpdateAccount via Management Console (WRITE method):**
- ‚úÖ Can update `METALS_TRADING_ACC` (directly owned by his desk)
- ‚ùå Cannot update `ALPHA_MASTER_ACC` (fund-owned account, different entity)
- ‚ùå Cannot update `BOND_TRADING_ACC` (different desk, sibling relationship)
- **Authentication**: Smart card + PIN for high-privilege operations
- **Use Case**: Desk-level account management with enhanced security requirements

**Compliance and Risk Benefits:**
- **Regulatory Segregation**: Each fund maintains separate compliance and reporting
- **Risk Isolation**: Department failures don't impact other organizational units
- **Operational Efficiency**: Specialized access patterns for different business functions
- **Consolidated Oversight**: Bank-level visibility for enterprise risk management

